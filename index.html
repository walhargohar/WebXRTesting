<script>
    // ... (keep tourData and your variables exactly as they are)

    function startEngine() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        // --- FIX: ESTABLISH XR-COMPATIBLE CONTEXT FOR META QUEST ---
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('webgl2', { xrCompatible: true }) || 
                        canvas.getContext('webgl', { xrCompatible: true });
        
        renderer = new THREE.WebGLRenderer({ 
            canvas: canvas, 
            context: context, 
            antialias: true, 
            powerPreference: "high-performance" 
        });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.xr.enabled = true; 
        document.getElementById('viewer').appendChild(renderer.domElement);

        // --- VR SESSION REQUEST FIX ---
        document.getElementById('emergency-vr-btn').onclick = () => {
            navigator.xr.requestSession('immersive-vr', {
                optionalFeatures: ['local-floor', 'bounded-floor']
            }).then(session => {
                renderer.xr.setSession(session);
            }).catch(err => {
                console.error("VR Session Failed:", err);
            });
        };

        // ... (Keep the rest of your OrbitControls, sphere, and interaction listeners exactly the same)
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.rotateSpeed = -0.4;
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = false; 
        controls.target.set(0, 0, 0);

        const geometry = new THREE.SphereGeometry(500, 60, 40);
        const material = new THREE.MeshBasicMaterial({ side: THREE.BackSide, color: 0x111111 });
        sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);

        window.addEventListener('pointerdown', onPointerDown);
        window.addEventListener('pointermove', onPointerMove);
        
        // (Keep the wheel and touch event listeners exactly as they were)
        
        if (tourData.scenes.length > 0) loadScene(tourData.scenes[0].id);
        renderer.setAnimationLoop(renderLoop);
    }

    // ... (Keep renderLoop and loadScene exactly as they are in your working backup)
</script>