<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360 Virtual Tour Pro - XR Enabled</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #viewer { width: 100vw; height: 100vh; background: #111; }
        
        /* EMERGENCY VR BUTTON */
        #emergency-vr-btn {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            padding: 18px 36px; background: #ef4444; color: white; border: none;
            border-radius: 12px; font-weight: bold; cursor: pointer; z-index: 2000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6); display: none; /* Hidden by default */
            font-size: 16px; text-transform: uppercase;
        }

        .hotspot {
            position: absolute; width: 44px; height: 44px; cursor: pointer;
            transform: translate(-50%, -50%); z-index: 100;
        }
        .hotspot img { width: 100%; height: 100%; pointer-events: none; }
        
        #room-label {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.9); padding: 10px 15px; border-radius: 6px;
            font-size: 11px; font-weight: bold; color: #333; z-index: 1000;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <div id="viewer"></div>
    <button id="emergency-vr-btn">ENTER VR (IMMERSIVE)</button>
    <div id="room-label">INITIALIZING...</div>

    <script>
        const tourData = {"scenes":[{"id":"scene-1766578310949-0","name":"2","image":"images/scene-1766578310949-0.jpg","hotspots":[{"id":"hotspot-1766578317415","position":[-1.7880416517426136,67.05156194034883,-495.07201525267925],"targetSceneId":"scene-1766578310952-1","icon":"icons/01.png","scale":1},{"id":"hotspot-1766578324563","position":[-496.49668413655905,-37.52640354795391,-38.71377282539662],"targetSceneId":"scene-1766578310954-2","icon":"icons/01.png","scale":1}]},{"id":"scene-1766578310952-1","name":"3","image":"images/scene-1766578310952-1.jpg","hotspots":[{"id":"hotspot-1766578330382","position":[268.51287924761647,-61.31558242732452,416.042352097742],"targetSceneId":"scene-1766578310949-0","icon":"icons/01.png","scale":1},{"id":"hotspot-1766578333890","position":[275.6862386446213,3.6748517634885483,-416.1599354953487],"targetSceneId":"scene-1766578310954-2","icon":"icons/01.png","scale":1}]},{"id":"scene-1766578310954-2","name":"BACKGROUND","image":"images/scene-1766578310954-2.jpg","hotspots":[{"id":"hotspot-1766578338004","position":[-78.98764378248819,66.10941715247557,-488.2532938864092],"targetSceneId":"scene-1766578310949-0","icon":"icons/01.png","scale":1},{"id":"hotspot-1766578341612","position":[139.03891719062557,-30.867974683876287,478.41946035854636],"targetSceneId":"scene-1766578310952-1","icon":"icons/01.png","scale":1}],"initialView":{"yaw":0.4028626613354817,"pitch":1.655804071366112}}]};
        let scene, camera, renderer, controls, sphere;

        // --- STEP 1: XR SUPPORT CHECK ---
        const emergencyBtn = document.getElementById('emergency-vr-btn');
        if ('xr' in navigator) {
            navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
                if (supported) emergencyBtn.style.display = 'block';
            });
        }

        window.onload = () => { startEngine(); };

        function startEngine() {
            try {
                const container = document.getElementById('viewer');
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                
                // --- VR OPTIMIZED RENDERER ---
                // We set 'xrCompatible: true' to prevent Quest context-loss crashes
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('webgl2', { xrCompatible: true }) || 
                                canvas.getContext('webgl', { xrCompatible: true });
                
                renderer = new THREE.WebGLRenderer({ 
                    canvas: canvas, context: context, antialias: true, powerPreference: "high-performance" 
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.xr.enabled = true; 
                
                container.appendChild(renderer.domElement);

                // --- EMERGENCY BUTTON LOGIC ---
                emergencyBtn.addEventListener('click', () => {
                    navigator.xr.requestSession('immersive-vr').then((session) => {
                        renderer.xr.setSession(session);
                        emergencyBtn.style.display = 'none';
                    }).catch(err => alert("VR Session Error: " + err.message));
                });

                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.rotateSpeed = -0.4;
                controls.enableZoom = false; 

                const geometry = new THREE.SphereGeometry(500, 60, 40);
                const material = new THREE.MeshBasicMaterial({ side: THREE.BackSide, color: 0x222222 });
                sphere = new THREE.Mesh(geometry, material);
                scene.add(sphere);

                // Desktop Zoom logic
                renderer.domElement.addEventListener('wheel', (e) => {
                    camera.fov += e.deltaY * 0.05;
                    camera.fov = Math.max(30, Math.min(100, camera.fov));
                    camera.updateProjectionMatrix();
                }, { passive: true });

                if (tourData && tourData.scenes && tourData.scenes.length > 0) {
                    loadScene(tourData.scenes[0].id);
                }

                // REQUIRED: VR sessions must use setAnimationLoop
                renderer.setAnimationLoop(() => {
                    if (!renderer.xr.isPresenting) controls.update();
                    renderer.render(scene, camera);
                });

                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });

            } catch (e) { document.getElementById('room-label').innerText = "ERROR: " + e.message; }
        }

        function loadScene(id) {
            const data = tourData.scenes.find(s => s.id === id);
            document.getElementById('room-label').innerText = "ROOM: " + data.name;

            new THREE.TextureLoader().load(data.image, (tex) => {
                tex.wrapS = THREE.RepeatWrapping; tex.repeat.x = -1;
                sphere.material.map = tex;
                sphere.material.color.set(0xffffff);
                sphere.material.needsUpdate = true;
                
                // Apply scene-specific default view
                if (data.initialView) {
                    const yaw = data.initialView.yaw || 0;
                    const pitch = data.initialView.pitch || 0;
                    camera.position.set(0.1 * Math.sin(yaw), 0.1 * Math.sin(pitch), 0.1 * Math.cos(yaw));
                } else {
                    camera.position.set(0, 0, 0.1);
                }
                controls.update();
            });

            // Handle Hotspots
            document.querySelectorAll('.hotspot').forEach(h => h.remove());
            data.hotspots.forEach(hs => {
                const el = document.createElement('div');
                el.className = 'hotspot';
                el.innerHTML = `<img src="${hs.icon}" alt="nav">`;
                el.onclick = () => loadScene(hs.targetSceneId);

                const pos = new THREE.Vector3(...hs.position);
                function sync() {
                    const vec = pos.clone().project(camera);
                    // Automatically hide 2D pins while in VR
                    if (vec.z < 1 && !renderer.xr.isPresenting) {
                        el.style.display = 'block';
                        el.style.left = `${(vec.x + 1) / 2 * window.innerWidth}px`;
                        el.style.top = `${-(vec.y - 1) / 2 * window.innerHeight}px`;
                    } else { el.style.display = 'none'; }
                    requestAnimationFrame(sync);
                }
                document.body.appendChild(el);
                sync();
            });
        }
    </script>
</body>
</html>